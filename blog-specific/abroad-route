#!/bin/bash
# Usage: param 0 is gateway. If no param, then set all known gateways

BASEDIR=/home/boj/smartproxy/conf
blockedlist=$BASEDIR/blocked-ip.txt
whitelist=$BASEDIR/forward-whitelist.txt

if [ ! -f "$blockedlist" ]; then
    echo "CIDR files not exist"
    exit 1
fi

function replace_table() {
    ip route flush table $2
    cat $3 | \
    while read prefix comment; do
        ip route add $prefix via $1 table $2
    done
}

specified_gw=$1
known_gw="10.9.0.1 10.10.0.1 10.11.0.1 10.12.0.1"

no=2000
for gw in $known_gw; do
    if [ -z "$specified_gw" ] || [ "$gw" == "$specified_gw" ]; then
        replace_table $gw $no $blockedlist
    fi
    no=$(($no+1))
done

if [ -f "$whitelist" ]; then
    replace_table 202.141.176.126 1999 $whitelist
fi

function replace_rule() {
    ip rule del $@ 2>/dev/null
    ip rule add $@
}

replace_rule fwmark 1 lookup 1999 pref 999  # whitelist
replace_rule fwmark 1 lookup 2000 pref 1000 # default
replace_rule fwmark 1 lookup 2001 pref 1001
replace_rule fwmark 1 lookup 2002 pref 1002
replace_rule fwmark 1 lookup 2003 pref 1003

replace_rule fwmark 2 lookup 1999 pref 999  # whitelist
replace_rule fwmark 2 lookup 2001 pref 1000 # default
replace_rule fwmark 2 lookup 2002 pref 1001
replace_rule fwmark 2 lookup 2003 pref 1002
replace_rule fwmark 2 lookup 2000 pref 1003

replace_rule fwmark 3 lookup 1999 pref 999  # whitelist
replace_rule fwmark 3 lookup 2002 pref 1000 # default
replace_rule fwmark 3 lookup 2003 pref 1001
replace_rule fwmark 3 lookup 2000 pref 1002
replace_rule fwmark 3 lookup 2001 pref 1003

replace_rule fwmark 4 lookup 1999 pref 999  # whitelist
replace_rule fwmark 4 lookup 2003 pref 1000 # default
replace_rule fwmark 4 lookup 2000 pref 1001
replace_rule fwmark 4 lookup 2001 pref 1002
replace_rule fwmark 4 lookup 2002 pref 1003

exit 0
