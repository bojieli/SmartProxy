#!/bin/bash

cd /home/boj/smartproxy/conf
if [ ! -f "USTC.txt" ]; then
    echo "CIDR files not exist"
    exit 1
fi

function set_route() {
    ip route flush table $2
    while read prefix comment; do
        if [[ "$prefix" =~ ^[0-9.]+(/[0-9]+)?$ ]]; then
            ip route add $prefix via $1 table $2
        fi
    done
}

# set up IP-in-IP tunnel
if [ $(ip tunnel | grep "tunipip" | wc -l) -eq 0 ]; then
    ip tunnel add tunipip mode ipip local 202.141.160.99 remote 202.38.95.110
fi
if [ $(ip addr | grep "10.38.160.99/32" | wc -l) -eq 0 ]; then
    ip addr add 10.38.160.99/32 dev tunipip
fi
ip link set tunipip up
ip route replace 10.38.95.110/32 dev tunipip

# define routing table preference (high to low)
route_pref="ustc cernet mobile telecom chnroutes whitelist blocked"

counter=10000
for i in $route_pref; do
    counter=$(($counter+1))
    eval $i=$counter
done

# generate routing tables
cat USTC.txt | set_route 202.141.160.126 $ustc
cat CHINANET.txt CNC.txt google.txt | set_route 202.141.160.126 $telecom
cat CMCC.txt | set_route 202.141.176.126 $mobile
cat CERNET.txt | set_route 10.38.95.110 $cernet
cat chnroutes.txt abroad-telecom.txt | set_route 202.141.160.126 $chnroutes
cat local-whitelist.txt | set_route 202.141.176.126 $whitelist
cat blocked-ip.txt | set_route 10.9.0.1 $blocked

# set up ip rule
counter=10000
for i in $route_pref; do
    counter=$(($counter+1))
    origpref=$(ip rule | grep "from all lookup $counter" | awk 'BEGIN{FS=":"}{print $1}')
    if [ ! -z "$origpref" ]; then
        ip rule del from all lookup $counter pref $origpref
    fi
    ip rule add from all lookup $counter pref $counter
done

# default for abroad route
ip route replace default via 202.141.176.126

exit 0
